input_number:
  caffeine_half_life_hours:
    name: "Caffeine Half-Life (hours)"
    min: 1
    max: 24
    step: 0.1
    initial: 5
    mode: slider
    icon: mdi:clock-time-five-outline

  caffeine_daily_goal:
    name: "Caffeine Daily Goal (mg)"
    min: 50
    max: 1000
    step: 10
    initial: 400
    mode: slider
    icon: mdi:target

  caffeine_last_added_amount:
    name: "Caffeine Last Added Amount (mg)"
    min: 0
    max: 5000
    step: 1
    initial: 0
    mode: box
    icon: mdi:coffee

input_text:
  caffeine_dose_log:
    name: "Caffeine Dose Log"
    initial: "[]"
    max: 255
    icon: mdi:format-list-bulleted

template:
  - sensor:
      - name: "caffeine_current_level_mg"
        unique_id: caffeine_current_level_mg
        unit_of_measurement: "mg"
        state_class: measurement
        icon: mdi:coffee
        state: >
          {% set log_raw = states('input_text.caffeine_dose_log') | default('[]') %}
          {% set half_life = states('input_number.caffeine_half_life_hours') | float(5) %}
          {% if half_life <= 0 %}
            {% set half_life = 5 %}
          {% endif %}
          {% set doses = log_raw | from_json if log_raw | length > 2 else [] %}
          {% set ns = namespace(total=0.0) %}
          {% for dose in doses %}
            {% set ts = dose.timestamp %}
            {% set dose_time = strptime(ts, '%Y-%m-%dT%H:%M:%S') %}
            {% set elapsed_seconds = (now().replace(tzinfo=none) - dose_time).total_seconds() %}
            {% set elapsed_hours = elapsed_seconds / 3600 %}
            {% if elapsed_hours < 0 %}
              {% set elapsed_hours = 0 %}
            {% endif %}
            {% set remaining = dose.amount | float(0) * (0.5 ** (elapsed_hours / half_life)) %}
            {% if remaining > 0 %}
              {% set ns.total = ns.total + remaining %}
            {% endif %}
          {% endfor %}
          {{ [ns.total, 0] | max | round(1) }}

      - name: "caffeine_peak_today_mg"
        unique_id: caffeine_peak_today_mg
        unit_of_measurement: "mg"
        state_class: measurement
        icon: mdi:chart-line
        state: >
          {% set current = states('sensor.caffeine_current_level_mg') | float(0) %}
          {% set previous_peak = this.state | float(0) %}
          {% if current > previous_peak %}
            {{ current }}
          {% else %}
            {{ previous_peak }}
          {% endif %}

      - name: "caffeine_time_until_zero"
        unique_id: caffeine_time_until_zero
        unit_of_measurement: "h"
        icon: mdi:timer-sand
        state: >
          {% set current = states('sensor.caffeine_current_level_mg') | float(0) %}
          {% set half_life = states('input_number.caffeine_half_life_hours') | float(5) %}
          {% if half_life <= 0 %}
            {% set half_life = 5 %}
          {% endif %}
          {% if current <= 1 %}
            0
          {% else %}
            {% set hours = (half_life / 0.693147) * ((current / 1) | log) %}
            {{ [hours, 0] | max | round(2) }}
          {% endif %}

      - name: "caffeine_remaining_to_goal"
        unique_id: caffeine_remaining_to_goal
        unit_of_measurement: "mg"
        state_class: measurement
        icon: mdi:gauge
        state: >
          {% set current = states('sensor.caffeine_current_level_mg') | float(0) %}
          {% set goal = states('input_number.caffeine_daily_goal') | float(400) %}
          {{ [goal - current, 0] | max | round(1) }}

      - name: "caffeine_status"
        unique_id: caffeine_status
        icon: mdi:information-outline
        state: >
          {% set current = states('sensor.caffeine_current_level_mg') | float(0) %}
          {% set goal = states('input_number.caffeine_daily_goal') | float(400) %}
          {% if current > 400 %}
            High (>400mg)
          {% elif current > goal %}
            Goal exceeded
          {% else %}
            OK
          {% endif %}
